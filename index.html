<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>Signage Slideshow</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      overflow: hidden;
      touch-action: manipulation;
    }
    #stage {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
    }

    .media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0;
      transition: opacity 600ms ease;
      object-position: center center;
    }
    .media.show { opacity: 1; }

    /* B案：fit をクラスで切り替える */
    .fit-contain { object-fit: contain; }
    .fit-cover   { object-fit: cover; }

    #hint {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      text-align: center;
      padding: 24px;
      background: rgba(0,0,0,0.35);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 250ms ease;
    }
    #hint.show { opacity: 1; pointer-events: auto; }
    #hint .box { max-width: 720px; line-height: 1.6; }
    #hint button {
      margin-top: 14px;
      font-size: 16px;
      padding: 10px 16px;
      border: 0;
      border-radius: 10px;
      background: #fff;
      color: #000;
    }

    #loading {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      text-align: center;
      padding: 24px;
      background: #000;
      z-index: 20;
      white-space: pre-wrap;
    }
    #loading.hidden { display: none; }
  </style>
</head>
<body>
  <div id="stage" aria-label="signage slideshow"></div>
  <div id="loading">読み込み中...</div>

  <div id="hint">
    <div class="box">
      <div style="font-size:18px;font-weight:700;margin-bottom:6px;">タップして再生開始</div>
      <div style="font-size:14px;opacity:0.9;">
        端末/ブラウザの仕様で動画の自動再生が止まることがあります。<br />
        1回タップすると、以降はスライドショーがループします。
      </div>
      <button id="startBtn" type="button">再生開始</button>
    </div>
  </div>

  <script>
    const MANIFEST_URL = "manifest.json";
    const IMAGE_DEFAULT_MS = 8000;
    const FADE_MS = 600;
    const AUTO_RELOAD_MS = 60 * 60 * 1000;

    // 表示領域（縦1080×1920想定）
    const SCREEN_RATIO = 1080 / 1920; // 0.5625
    const RATIO_TOLERANCE = 0.15;     // ±15%

    const stage = document.getElementById("stage");
    const hint = document.getElementById("hint");
    const startBtn = document.getElementById("startBtn");
    const loading = document.getElementById("loading");

    let PLAYLIST = [];
    let currentIndex = 0;
    let currentEl = null;
    let timerId = null;
    let started = false;

    function clearTimer() {
      if (timerId) {
        clearTimeout(timerId);
        timerId = null;
      }
    }

    function extOf(path) {
      const m = path.toLowerCase().match(/\.([a-z0-9]+)(\?.*)?$/);
      return m ? m[1] : "";
    }

    function typeFromSrc(src) {
      const ext = extOf(src);
      if (ext === "mp4" || ext === "webm") return "video";
      return "image";
    }

    function decideFit(mediaW, mediaH) {
      if (!Number.isFinite(mediaW) || !Number.isFinite(mediaH) || mediaW <= 0 || mediaH <= 0) {
        return "fit-contain"; // 取得できない時は安全側（見切れない）
      }
      const ratio = mediaW / mediaH;
      const diff = Math.abs(ratio - SCREEN_RATIO) / SCREEN_RATIO;
      return diff <= RATIO_TOLERANCE ? "fit-cover" : "fit-contain";
    }

    function setFitClass(el, fitClass) {
      el.classList.remove("fit-contain", "fit-cover");
      el.classList.add(fitClass);
    }

    function makeMediaEl(item) {
      if (item.type === "video") {
        const v = document.createElement("video");
        v.className = "media fit-contain"; // ★最初から必ず付与（小さくなる事故を防ぐ）
        v.src = item.src;

        // ★Android/iOS両方で安定させるセット
        v.playsInline = true;
        v.setAttribute("playsinline", "");
        v.setAttribute("webkit-playsinline", "");

        v.muted = true;
        v.defaultMuted = true;
        v.volume = 0;
        v.setAttribute("muted", "");

        v.autoplay = false;
        v.loop = false;
        v.controls = false;
        v.preload = "auto";

        return v;
      } else {
        const img = document.createElement("img");
        img.className = "media fit-contain"; // ★最初から必ず付与
        img.src = item.src;
        img.alt = "";
        img.decoding = "async";
        img.loading = "eager";
        return img;
      }
    }

    function showEl(el) {
      requestAnimationFrame(() => el.classList.add("show"));
    }

    function hideAndRemoveEl(el) {
      if (!el) return;
      el.classList.remove("show");
      setTimeout(() => {
        try { el.pause?.(); } catch (_) {}
        if (el.parentNode) el.parentNode.removeChild(el);
      }, FADE_MS + 50);
    }

    async function applyFit(el, type) {
      if (type === "image") {
        const w = el.naturalWidth;
        const h = el.naturalHeight;
        setFitClass(el, decideFit(w, h));
      } else {
        const w = el.videoWidth;
        const h = el.videoHeight;
        setFitClass(el, decideFit(w, h));
      }
    }

    async function playItem(index) {
      clearTimer();

      const item = PLAYLIST[index];
      const el = makeMediaEl(item);
      stage.appendChild(el);

      hideAndRemoveEl(currentEl);
      currentEl = el;

      if (item.type === "image") {
        await new Promise((resolve) => {
          if (el.complete) return resolve();
          el.onload = () => resolve();
          el.onerror = () => resolve();
        });

        await applyFit(el, "image");
        showEl(el);

        timerId = setTimeout(() => goNext(), IMAGE_DEFAULT_MS);
        return;
      }

      // video: metadataが取れない端末があるので load() を明示
      try { el.load(); } catch (_) {}

      await new Promise((resolve) => {
        const done = () => resolve();
        el.onloadedmetadata = done;
        el.oncanplay = done;
        el.onerror = done;
        // 念のためタイムアウト（無限待ち防止）
        setTimeout(done, 4000);
      });

      await applyFit(el, "video");
      showEl(el);

      try {
        await el.play();
      } catch (e) {
        // ★再生失敗時は必ず操作を促す
        started = false;
        hint.classList.add("show");
        return;
      }

      el.onended = () => goNext();

      if (Number.isFinite(el.duration) && el.duration > 0) {
        const fallbackMs = Math.ceil(el.duration * 1000) + 500;
        timerId = setTimeout(() => goNext(), fallbackMs);
      } else {
        // durationが取れない時の保険
        timerId = setTimeout(() => goNext(), 15000);
      }
    }

    function goNext() {
      if (!PLAYLIST.length) return;
      currentIndex = (currentIndex + 1) % PLAYLIST.length;
      playItem(currentIndex);
    }

    function startSlideshow() {
      if (!PLAYLIST.length) return;
      hint.classList.remove("show");
      started = true;
      playItem(currentIndex);
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && started) {
        if (currentEl && currentEl.tagName === "VIDEO") {
          currentEl.play().catch(() => {
            started = false;
            hint.classList.add("show");
          });
        }
      }
    });

    async function loadManifest() {
      const res = await fetch(MANIFEST_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("manifest.json を取得できませんでした");

      const data = await res.json();
      const files = Array.isArray(data.files) ? data.files : [];

      PLAYLIST = files.filter(Boolean).map(src => ({
        src,
        type: typeFromSrc(src)
      }));

      if (!PLAYLIST.length) throw new Error("再生対象が0件です");
    }

    function setupAutoReload() {
      setTimeout(() => {
        const url = new URL(location.href);
        url.searchParams.set("_ts", String(Date.now()));
        location.replace(url.toString());
      }, AUTO_RELOAD_MS);
    }

    async function boot() {
      try {
        await loadManifest();
        loading.classList.add("hidden");
        setupAutoReload();
        startSlideshow();
        setTimeout(() => {
          if (!started) hint.classList.add("show");
        }, 400);
      } catch (e) {
        loading.textContent = "読み込み失敗: " + e.message;
      }
    }

    startBtn.addEventListener("click", startSlideshow);
    hint.addEventListener("click", startSlideshow);

    stage.addEventListener("click", () => {
      if (hint.classList.contains("show")) return;
      goNext();
    });

    boot();
  </script>
</body>
</html>