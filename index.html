<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>Signage Slideshow</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      touch-action: manipulation;
    }
    #stage {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
    }
    .media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      opacity: 0;
      transition: opacity 600ms ease;
    }
    .media.show { opacity: 1; }

    /* 16:9など横長は画面いっぱい */
    @media (min-aspect-ratio: 16/9) {
      .media { object-fit: cover; }
    }

    #hint {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      text-align: center;
      padding: 24px;
      background: rgba(0,0,0,0.35);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 250ms ease;
    }
    #hint.show { opacity: 1; pointer-events: auto; }
    #hint .box { max-width: 720px; line-height: 1.6; }
    #hint button {
      margin-top: 14px;
      font-size: 16px;
      padding: 10px 16px;
      border: 0;
      border-radius: 10px;
      background: #fff;
      color: #000;
    }

    #loading {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      text-align: center;
      padding: 24px;
      background: #000;
      z-index: 20;
    }
    #loading.hidden { display: none; }
  </style>
</head>
<body>
  <div id="stage" aria-label="signage slideshow"></div>

  <div id="loading">読み込み中...</div>

  <div id="hint">
    <div class="box">
      <div style="font-size:18px;font-weight:700;margin-bottom:6px;">タップして再生開始</div>
      <div style="font-size:14px;opacity:0.9;">
        Android Chromeでも状況により自動再生が止まることがあります。<br />
        1回タップすると、以降はスライドショーがループします。
      </div>
      <button id="startBtn" type="button">再生開始</button>
    </div>
  </div>

  <script>
    // =========================
    // 設定
    // =========================
    const MANIFEST_URL = "manifest.json"; // GitHub Actionsが生成する
    const IMAGE_DEFAULT_MS = 8000;        // 画像の表示時間（8秒）
    const FADE_MS = 600;

    // =========================
    // DOM
    // =========================
    const stage = document.getElementById("stage");
    const hint = document.getElementById("hint");
    const startBtn = document.getElementById("startBtn");
    const loading = document.getElementById("loading");

    // =========================
    // 状態
    // =========================
    let PLAYLIST = [];
    let currentIndex = 0;
    let currentEl = null;
    let timerId = null;
    let started = false;

    function clearTimer() {
      if (timerId) {
        clearTimeout(timerId);
        timerId = null;
      }
    }

    function extOf(path) {
      const m = path.toLowerCase().match(/\.([a-z0-9]+)(\?.*)?$/);
      return m ? m[1] : "";
    }

    function typeFromSrc(src) {
      const ext = extOf(src);
      if (ext === "mp4" || ext === "webm") return "video";
      return "image";
    }

    function makeMediaEl(item) {
      if (item.type === "video") {
        const v = document.createElement("video");
        v.className = "media";
        v.src = item.src;
        v.playsInline = true;
        v.muted = true;   // 自動再生のため
        v.autoplay = false;
        v.loop = false;
        v.controls = false;
        v.preload = "auto";
        return v;
      } else {
        const img = document.createElement("img");
        img.className = "media";
        img.src = item.src;
        img.alt = "";
        img.decoding = "async";
        img.loading = "eager";
        return img;
      }
    }

    function showEl(el) {
      requestAnimationFrame(() => el.classList.add("show"));
    }

    function hideAndRemoveEl(el) {
      if (!el) return;
      el.classList.remove("show");
      setTimeout(() => {
        try { el.pause?.(); } catch (_) {}
        if (el.parentNode) el.parentNode.removeChild(el);
      }, FADE_MS + 50);
    }

    async function playItem(index) {
      clearTimer();

      const item = PLAYLIST[index];
      const nextEl = makeMediaEl(item);
      stage.appendChild(nextEl);

      hideAndRemoveEl(currentEl);
      currentEl = nextEl;

      if (item.type === "image") {
        await new Promise((resolve) => {
          if (nextEl.complete) return resolve();
          nextEl.onload = () => resolve();
          nextEl.onerror = () => resolve();
        });

        showEl(nextEl);

        const ms = Number.isFinite(item.durationMs) ? item.durationMs : IMAGE_DEFAULT_MS;
        timerId = setTimeout(() => goNext(), ms);
        return;
      }

      await new Promise((resolve) => {
        const done = () => resolve();
        nextEl.onloadedmetadata = done;
        nextEl.oncanplay = done;
        nextEl.onerror = done;
      });

      showEl(nextEl);

      try {
        await nextEl.play();
      } catch (e) {
        started = false;
        hint.classList.add("show");
        return;
      }

      // 動画は完走してから次へ
      nextEl.onended = () => goNext();

      // 保険（万一endedが飛ばないケース用）
      if (Number.isFinite(nextEl.duration) && nextEl.duration > 0) {
        const fallbackMs = Math.ceil(nextEl.duration * 1000) + 500;
        timerId = setTimeout(() => goNext(), fallbackMs);
      }
    }

    function goNext() {
      if (!PLAYLIST.length) return;
      currentIndex = (currentIndex + 1) % PLAYLIST.length;
      playItem(currentIndex);
    }

    function startSlideshow() {
      if (!PLAYLIST.length) return;
      hint.classList.remove("show");
      started = true;
      playItem(currentIndex);
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && started) {
        if (currentEl && currentEl.tagName === "VIDEO") {
          currentEl.play().catch(() => {
            started = false;
            hint.classList.add("show");
          });
        }
      }
    });

    // =========================
    // manifest.json 読み込み
    // =========================
    async function loadManifest() {
      const res = await fetch(MANIFEST_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("manifest.json を取得できませんでした");
      const data = await res.json();

      // 形式: { "files": ["images/a.jpg", "images/b.png", ...] }
      const files = Array.isArray(data.files) ? data.files : [];
      const items = files
        .filter(Boolean)
        .map((src) => ({
          src,
          type: typeFromSrc(src),
          durationMs: typeFromSrc(src) === "image" ? IMAGE_DEFAULT_MS : undefined
        }));

      // 空ならエラー
      if (!items.length) throw new Error("再生対象が0件です（images/ が空か、拡張子フィルタ対象外）");

      PLAYLIST = items;
      currentIndex = 0;
    }

    async function boot() {
      try {
        await loadManifest();
        loading.classList.add("hidden");

        // まず自動開始を試す（ダメならヒントが出る）
        startSlideshow();

        setTimeout(() => {
          if (!started) hint.classList.add("show");
        }, 400);

      } catch (e) {
        loading.textContent = "読み込み失敗: " + (e?.message || String(e));
      }
    }

    startBtn.addEventListener("click", startSlideshow);
    hint.addEventListener("click", startSlideshow);

    stage.addEventListener("click", () => {
      if (hint.classList.contains("show")) return;
      goNext();
    });

    boot();
  </script>
</body>
</html>
