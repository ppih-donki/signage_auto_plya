name: Generate manifest.json

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate manifest.json
        shell: bash
        run: |
          set -e

          python3 - <<'PY'
          import json
          from pathlib import Path

          # images/ 配下は引き続き自動スキャン
          IMG_DIR = Path("images")
          exts = {".jpg", ".jpeg", ".png", ".webp", ".mp4", ".webm"}
          image_files = []
          if IMG_DIR.exists() and IMG_DIR.is_dir():
            for p in IMG_DIR.iterdir():
              if p.is_file() and p.suffix.lower() in exts:
                # GitHub Pagesで参照できる相対パスにする
                image_files.append(str(p.as_posix()))
          image_files.sort()

          # 大容量動画は videos.json にURLで列挙して混在させる
          video_urls = []
          vp = Path("videos.json")
          if vp.exists() and vp.is_file():
            try:
              data = json.loads(vp.read_text(encoding="utf-8"))
            except Exception:
              data = None

            if isinstance(data, list):
              candidates = data
            elif isinstance(data, dict) and isinstance(data.get("videos"), list):
              candidates = data.get("videos")
            else:
              candidates = []

            for u in candidates:
              if isinstance(u, str) and u.strip():
                video_urls.append(u.strip())

          manifest = {"files": image_files + video_urls}
          Path("manifest.json").write_text(json.dumps(manifest, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          print(Path("manifest.json").read_text(encoding="utf-8"))
          PY

      - name: Commit and push if changed
        shell: bash
        run: |
          set -e
          if git diff --quiet -- manifest.json; then
            echo "manifest.json unchanged"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          git commit -m "Update manifest.json"
          git push
